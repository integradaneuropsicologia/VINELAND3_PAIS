<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventário de Comportamento Adaptativo</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e; --chipSel:#1e293b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}
  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}
  .section{margin:18px 0 8px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(0,0,0,.18);font-weight:700}
  .item{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(0,0,0,.18);margin-bottom:12px}
  .stem{font-size:1rem;margin-bottom:10px}
  .scale{display:grid;grid-template-columns:repeat(3,minmax(200px,1fr));gap:10px}
  @media (max-width:820px){ .scale{grid-template-columns:1fr} }
  .opt{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:var(--chip);cursor:pointer;transition:background .15s,border-color .15s,transform .05s}
  .opt:hover{background:var(--chipHover);border-color:#4f70ff;transform:translateY(-1px)}
  .opt input{appearance:none;-webkit-appearance:none;width:0;height:0;position:absolute;opacity:0}
  .opt span{font-weight:600}
  .opt small{opacity:.8}
  .opt:has(input:checked){background:var(--chipSel);border-color:#6d28d9;box-shadow:0 0 0 1px #6d28d9 inset}
  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:.86rem}
  .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.ok{background:var(--ok)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--muted)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}
  .progress{height:10px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#6d28d9,#10b981)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Inventário de Comportamento Adaptativo (Pais)</h1>
    <p class="muted">
      Opções de respostas:
    </p>

    <div class="legend">
      <span class="pill">Usualmente ou frequentemente</span>
      <span class="pill">Às vezes</span>
      <span class="pill">Nunca</span>
      <span class="pill">Não se aplica</span>
    </div>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none;gap:8px;align-items:center;margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/0</span>
        <button id="clearDraft" class="btn ghost" type="button">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px;display:none" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_VINELAND3_PAIS" };
const CODE = "VINELAND3_PAIS";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["VINELAND3_PAIS"]; // coluna(s) de liberação no Patients, com valor "sim"

/* ========= HELPERS ========= */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent=text;
  el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display="block";
}
function hideBox(id){
  const el=$(id); if(!el) return;
  el.style.display="none"; el.textContent="";
}
function maskCPF(cpf){
  const d=onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d]=String(iso).split("-");
  return (y&&m&&d)?`${d}/${m}/${y}`:iso;
}
async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp=new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r=await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({data:[row]})
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r=await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({data})
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
const TOKEN = qs("token");
function goPortalWithToken(){
  try{
    const u=new URL(PORTAL_URL,location.href);
    if(TOKEN) u.searchParams.set("token",TOKEN);
    location.href=u.toString();
  }catch(_){
    const sep=PORTAL_URL.includes("?")?"&":"?";
    location.href=PORTAL_URL+(TOKEN?sep+"token="+encodeURIComponent(TOKEN):"");
  }
}

/* ========= DOMÍNIOS E ITENS ========= */
const DOMAINS = [
  {
    key:"COM",
    label:"Comunicação",
    items: [
      "Sabe como dizer mais de um de alguma coisa (ex.: “dois gatos”, “mais bolachas”, “aquelas flores”)?",
      "Usa “e” em frases (ex.: “Mamãe e papai estão aqui”; “Eu quero sorvete e bolo”)?",
      "Segue instruções do tipo “se–então” (ex.: “Se você está com sede, então pegue uma bebida”; “Se está com frio, então pegue um moletom”)?",
      "Responde a perguntas que usam quando (ex.: “Quando você toma café da manhã?” – “De manhã”)?",
      "Presta atenção a uma história por pelo menos 15 minutos?",
      "Responde a perguntas que usam por que (ex.: “Por que você está chorando?” – “Meu brinquedo quebrado”)?",
      "Faz pelo menos três gestos avançados (ex.: chamar com a mão; dedo nos lábios para silêncio; mãos para “desse tamanho”; dar de ombros para “não sei”)?",
      "Usa adjetivos para descrever coisas (ex.: “retrato bonito”, “cachorrinho grande”)?",
      "Diz nome e sobrenome quando você pergunta?",
      "Segue instruções para fazer a mesma ação com dois objetos diferentes (ex.: “Traga os lápis e a bola”; “Coloque a camisa e os sapatos”)?",
      "Segue instruções para fazer duas coisas não relacionadas (ex.: “Desligue a TV e pegue minhas chaves”)?",
      "Usa pronomes corretamente (ex.: eu, ela, nós, eles, seus, nossos, deles)?",
      "Usa sentenças de duas partes unidas por “e” ou “mas” (ex.: “Ela perguntou e eu disse não”; “Júlio queria ir, mas eu não”)?",
      "Sabe dizer que algo aconteceu no passado (ex.: “Eu andei até a loja”; “Maria assou um bolo”)?",
      "Identifica esquerda e direita no próprio corpo?",
      "Conta as partes básicas de uma história familiar (personagens, o que acontece, como termina etc.)?",
      "Segue instruções de três passos (ex.: “Vista-se, tome o café da manhã e escove os dentes”)?",
      "Fala sobre eventos cotidianos em detalhes (ex.: conta o que aconteceu na casa de um amigo hoje)?",
      "Copia o primeiro nome sem erros?",
      "Segue direções envolvendo esquerda e direita (ex.: “Vá para a esquerda”; “Olhe para a direita”)?",
      "Diz de outra maneira quando precisa para ajudar alguém a entender o que quer dizer?",
      "Presta atenção a uma aula/apresentação informativa de 15 minutos e compreende o que está sendo dito?",
      "Escreve frases simples com três ou mais palavras?",
      "Escreve letras do alfabeto corretamente (não de trás para frente ou de cabeça para baixo)?",
      "Quando é para fazer algo um pouco mais tarde, lembra-se de fazer (ex.: “Quando o programa acabar, coloque os pratos na pia”)?",
      "Escreve de cabeça pelo menos 10 palavras (ex.: chapéu, bola etc.)?",
      "Entende quando alguém está sendo sarcástico (ex.: “Isso é ótimo!” querendo dizer “Isso é horrível”)?",
      "Lê em voz alta sentenças simples com três ou mais palavras?",
      "Compreende a ordem alfabética (ex.: acha um nome em lista/telefone; encontra palavra em dicionário)?",
      "Presta atenção a uma palestra informativa de 30 minutos e compreende?",
      "Diz o endereço completo corretamente (inclui cidade e estado)?",
      "Quando é para fazer algo muito mais tarde naquele dia, lembra-se de fazer (ex.: “Quando chegar da escola, solte o cachorro”)?",
      "Lê em nível de segundo ano ou superior?",
      "Dá direções complexas com três ou mais etapas (ex.: direções de rua; instruções de receita)?",
      "Escreve ou desenha instruções para os outros (ex.: como fazer algo; como chegar a um lugar)?",
      "Usa internet ou biblioteca para encontrar informações para um trabalho ou tarefa?",
      "Verifica e corrige o trabalho escrito antes de entregar (ex.: confere ortografia no computador)?",
      "Preenche formulários de até uma página (papel ou eletrônicos) para escola ou trabalho?",
      "Lê em nível de sexto ano ou superior?",
      "Escreve relatórios com pelo menos três páginas usando as próprias palavras (sem copiar)?"
    ]
  },
  {
    key:"AVD",
    label:"Atividades de Vida Diária",
    items: [
      "Usa o banheiro durante o dia (pode precisar de ajuda para abaixar a calça, mas identifica quando precisa ir)?",
      "Conta pelo menos 10 objetos, um por um?",
      "Compreende que dinheiro é usado para comprar coisas (não precisa usar dinheiro sozinho[a])?",
      "Limpa o rosto e as mãos quando come algo melequento?",
      "Fica perto em locais públicos (ser carregado/empurrado em carrinho não conta)?",
      "Coloca roupas que vestem pela cabeça (ex.: camiseta, camisa, vestido)?",
      "Tem cuidado com coisas que podem queimá-lo(a) (ex.: fogão, forno, fogo)?",
      "Coloca a roupa com o lado correto para a frente e o lado correto para trás?",
      "Compreende e segue regras de segurança dos passageiros (ex.: cinto afivelado; não distrai o motorista)?",
      "Usa o banheiro durante o dia e à noite sem ajuda (limpa-se, dá descarga e lava as mãos sozinho[a])?",
      "Escova os dentes (coloca pasta, escova bem e enxágua)?",
      "Coloca botões grandes nos buracos corretos (ex.: botões de casaco)?",
      "Liga as torneiras e ajusta a temperatura da água?",
      "Tem cuidado ao usar objetos pontiagudos (ex.: facas, tesouras)?",
      "Olha para os dois lados ao atravessar ruas/estradas?",
      "Limpa quando derrama algo?",
      "Sabe quais são alimentos saudáveis e não saudáveis?",
      "Sabe o que fazer em situações perigosas (ex.: quando obter ajuda; quando ligar 190; como fugir do perigo)?",
      "Faz o próprio lanche ou refeição simples (ex.: sanduíche, queijo e bolachas, micro-ondas)?",
      "Liga para outras pessoas usando telefone/computador/outro dispositivo eletrônico?",
      "Localiza uma data em um calendário quando você pergunta (ex.: hoje; dia do aniversário)?",
      "Age com segurança ao trabalhar e/ou se divertir (ex.: usa equipamento de segurança; cuidado com ferramentas/maquinário)?",
      "Guarda roupas limpas onde pertencem (ex.: gavetas, armário, cabides)?",
      "Usa pelo menos dois utensílios de cozinha simples (ex.: torradeira, micro-ondas, abridor elétrico de latas)?",
      "Lava frutas e verduras antes de comer ou cozinha-as?",
      "Escolhe se exercitar por saúde ou prazer?",
      "Muda de roupa conforme o clima; identifica quando usar guarda-chuva ou casaco?",
      "Opera tecnologia para ao menos dois tipos de tarefas (ex.: escrever documentos; enviar e-mails; organizar/achar informações na internet)?",
      "Mantém em segurança, fora de casa, dinheiro/carteira/telefone etc. (ex.: compras, restaurante, viagem)?",
      "Usa produtos domésticos corretamente (ex.: sabão em pó para roupas; polidor de móveis; limpa-vidros)?",
      "Lava a louça (à mão ou na máquina)?",
      "Mantém a casa segura quando sai (ex.: tranca portas, fecha janelas, liga o alarme)?",
      "Corta alimentos mais difíceis com faca afiada (ex.: carne, vegetais crus)?",
      "Considera qualidade e preço ao decidir o que comprar?",
      "Entende o direito de relatar um problema com um produto, serviço ou moradia?",
      "Estabelece um objetivo de seis meses ou mais e alcança (ex.: trabalhar e economizar; melhorar a forma física)?",
      "Usa fogão ou forno para cozinhar/assar (liga e desliga sozinho[a])?",
      "Limpa o banheiro (vaso, pia, banheira/chuveiro etc.)?",
      "Mede a própria temperatura quando necessário?",
      "Trabalhou fora de casa para ganhar dinheiro (ex.: babá; trabalho para vizinho; emprego)?"
    ]
  },
  {
    key:"SOC",
    label:"Socialização",
    items: [
      "Diz como os membros da família estão relacionados a ele(a)? (Ex.: “Essa é minha mãe”, “Ele é meu irmão”.)",
      "Percebe quando outros estão felizes, tristes, com medo, chateados, etc.?",
      "Usa palavras para expressar suas emoções? (Ex.: “Eu estou feliz”, “Eu estou com medo”, “Eu não gosto dele”.)",
      "Tem um melhor amigo ou alguns bons amigos?",
      "Usa ações ou palavras para mostrar aos outros que ele(a) se sente feliz por eles, triste por eles ou preocupado com eles? (Ex.: dá abraços, dá a mão, pergunta “Você está bem?”.)",
      "Brinca com uma ou mais crianças por pelo menos 30 minutos, com alguém mais velho supervisionando?",
      "Divide seus brinquedos ou outras coisas quando alguém pede para ele(a) fazê-lo?",
      "Muda facilmente de uma atividade para outra? (Ex.: da hora de brincar para o banho, sem ficar muito chateado.)",
      "Faz bom contato visual quando interage com as pessoas?",
      "Prefere brincar com outras crianças ao invés de só observá-las ou brincar sozinho(a)?",
      "Brinca de brincadeiras simples, de faz de conta, com outras crianças? (Ex.: fantasiar-se, fingir ser super-herói.)",
      "Tenta fazer amizade com outros de sua idade? (Ex.: convida para um jogo, pede para ir a algum lugar com outra criança.)",
      "Desculpa-se depois de ferir os sentimentos de alguém, e de forma genuína?",
      "Conversa com volume, velocidade e nível de empolgação corretos para uma conversa?",
      "Imita uma criança brincando por perto, mesmo que não estejam brincando juntas? (Ex.: vê outra criança empilhando blocos e começa a empilhar.)",
      "Aceita revezar quando brinca de jogos ou pratica esportes?",
      "Usa palavras ou gestos quando está chateado(a) em vez de gritar, bater, jogar algo, etc.?",
      "Está disposto(a) a fazer concessões para se dar bem com outras pessoas da sua idade?",
      "Faz coisas para tentar agradar os outros? (Ex.: faz um cartão/presente, oferece ajuda sem ser solicitado.)",
      "Muda facilmente de um assunto para outro em uma conversa quando necessário? (Não fica “preso” em um só assunto.)",
      "Demonstra bom senso esportivo em jogos ou esportes? (Joga de maneira justa, não é excessivamente agressivo, parabeniza vencedores, não age mal quando perde.)",
      "Segue os limites de tempo fornecidos pelos responsáveis? (Ex.: quanto tempo pode assistir TV, jogar, usar internet, brincar fora de casa.)",
      "É cauteloso(a) quando alguém que ele(a) não conhece bem tenta fazer com que ele(a) faça algo arriscado (pessoalmente ou pela internet)?",
      "Junta-se com dois ou mais indivíduos de sua idade na casa de outra pessoa?",
      "Conversa com os outros sobre coisas nas quais eles estão interessados, mesmo que ele(a) não esteja?",
      "Percebe quando alguém precisa de alguma explicação para acompanhar o que ele(a) está dizendo?",
      "Fica de fora de um grupo quando deixam transparecer, sem palavras, que ele(a) não é bem-vindo(a)? (Ex.: ignorando-o/a.)",
      "Engaja em jogos de tabuleiro, cartas ou jogos eletrônicos que requeiram decisões e habilidades? (Ex.: Banco Imobiliário, pôquer, damas, videogames interativos.)",
      "Controla a raiva ou mágoa quando os planos mudam por razões que não podem ser controladas? (Ex.: não chora nem fica bravo/a quando um evento é cancelado pelo mau tempo.)",
      "Respeita o tempo das outras pessoas? (Não deixa esperando; não interrompe quando estão ocupados.)",
      "Impede que os outros o/a controlem ou tirem vantagem dele(a)?",
      "Faz coisas que os amigos querem fazer, mesmo quando preferiria fazer outra coisa?",
      "Pensa nas consequências de seus atos antes de fazer alguma coisa?",
      "Entende que uma pessoa agindo amigavelmente pode estar querendo tirar vantagem dele(a)?",
      "Deixa você saber sobre seus planos quando vai sair? (Informa ou deixa mensagem sobre onde vai e quando estará em casa.)",
      "Entende que algumas coisas veiculadas na publicidade podem não ser verdadeiras?",
      "Pega dicas implícitas durante a conversa? (Ex.: bocejo = tédio; mudar de assunto para evitar tema; olhar para o relógio = precisa encerrar.)",
      "Planeja ou toma a iniciativa de fazer coisas com outros da mesma idade sozinho(a)? (Ex.: planeja jantar com amigo, ir ao cinema no fim de semana.)",
      "Obtém informações de programação para filmes, eventos esportivos, shows etc.? (Ex.: olha no jornal/internet, telefona para obter informações.)",
      "Vai a lugares com outros indivíduos de sua idade durante o dia sem alguém supervisionando? (Ex.: shopping, parque, centro comunitário.)"
    ]
  },
  {
    key:"HMOT",
    label:"Atividades",
    items: [
      "Desembrulha pequenos objetos? (Ex.: pedaço de doce ou chiclete.)",
      "Desce escadas, colocando um pé em cada degrau? (Pode usar corrimão.)",
      "Sobe um conjunto de oito ou mais degraus em ritmo normal? (Pode usar corrimão.)",
      "Corre sem dificuldade, mudando velocidade e direção? (Ex.: pega-pega, praticar esportes, perseguir um animal.)",
      "Salta para a frente pelo menos três vezes com os dois pés sem cair?",
      "Segura giz de cera, caneta ou lápis corretamente para escrever/desenhar (não em preensão palmar)?",
      "Anda duas quadras ou mais sem precisar de ajuda ou descansar?",
      "Desenha um círculo à mão enquanto olha um modelo?",
      "Pedala um triciclo ou outro veículo com três rodas por pelo menos 2 metros?",
      "Pega uma bola do tamanho de uma bola de praia a cerca de 2 metros? (Uma ou duas mãos.)",
      "Pula com um pé só com facilidade, sem cair?",
      "Pinta formas simples ou animais, ficando mais dentro do que fora da linha?",
      "Pedala bicicleta com rodinhas ou bicicleta de equilíbrio por pelo menos 3 metros?",
      "Desenha mais de uma forma reconhecível? (Ex.: pessoa, casa, árvore.)",
      "Transfere líquido de um recipiente para outro com pouco ou nenhum derramamento? (Ex.: coloca leite/suco em um copo.)",
      "Pega uma bola do tamanho de tênis/beisebol a 0,5–1 m, afastando-a do corpo ao pegar? (Uma ou ambas as mãos.)",
      "Recorta formas simples? (Ex.: círculos, quadrados, retângulos.)",
      "Faz construções complexas usando brinquedos de montar, materiais de arte/artesanato etc.?",
      "Desenha uma linha reta com uma régua?",
      "Pega uma bola do tamanho de tênis/beisebol a 3 m, movendo-se para pegá-la se necessário? (Uma ou ambas as mãos.)",
      "Amarra um nó?",
      "Recorta formas complexas? (Ex.: estrelas, animais, letras do alfabeto.)",
      "Trabalha com objetos bem pequenos? (Ex.: ajusta um relógio, enfia linha na agulha, cola peças pequenas.)",
      "Pedala uma bicicleta regular, sem rodinhas, sem cair?",
      "Faz um laço apertado? (Ex.: cadarço de sapato, laço de presente.)"
    ]
  }
];

/* ========= RENDER ========= */
function renderQuestions(){
  const host=$("#qs"); host.innerHTML="";
  let count=0;

  DOMAINS.forEach(domain=>{
    const sec=document.createElement('div');
    sec.className='section';
    sec.textContent=domain.label;
    host.appendChild(sec);

    domain.items.forEach(txt=>{
      count++;
      const qn=String(count).padStart(3,'0');

      const row=document.createElement('div');
      row.className='item';
      row.setAttribute('data-q',String(count));

      const stem=document.createElement('div');
      stem.className='stem';
      stem.id=`s${qn}`;
      stem.textContent = `${count}. ${txt}`;

      const scale=document.createElement('div');
      scale.className='scale';

      // valores:
      // 0 = Nunca
      // 1 = Às vezes
      // 2 = Frequentemente / Usualmente
      // 0 = Não se aplica (contribui 0 no score)
      const CHOICES=[
        {v:2,l:'Usualmente ou frequentemente'},
        {v:1,l:'Às vezes'},
        {v:0,l:'Nunca'},
        {v:0,l:'Não se aplica'}
      ];

      CHOICES.forEach(c=>{
        const lab=document.createElement('label');
        lab.className='opt';
        lab.title=`${c.l} (${c.v})`;
        const id=`q${qn}_${c.v}_${c.l.replace(/\s+/g,'_')}`;
        lab.innerHTML=`
          <input type="radio" name="q${qn}" id="${id}" value="${c.v}" required aria-labelledby="s${qn}">
          <span>${c.l}</span><small></small>`;
        scale.appendChild(lab);
      });

      row.append(stem,scale);
      host.appendChild(row);
    });
  });

  // Atualiza total para progresso inicial
  $("#progressText").textContent = `Progresso: 0/${count}`;
}

/* ========= ESTADO ========= */
let patient=null, tokenRow=null, CPF="";
const STORAGE_KEY = `VINELAND3_PAIS_${qs("token")||"anon"}`;
let startAt = Date.now();

/* ========= BOOT ========= */
(async function boot(){
  try{
    if(!TOKEN){
      setBox("#alert","Link inválido (sem token). Solicite um novo link.","err");
      return;
    }

    const trows=await sheetSearch(SHEETS.TOKENS,{token:TOKEN});
    if(!trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow=trows[0];
    if(String(tokenRow.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date()) throw new Error("Token expirado.");
    CPF=onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows=await sheetSearch(SHEETS.PATIENTS,{cpf:CPF});
    if(!prows.length) throw new Error("Paciente não encontrado.");
    patient=prows[0];

    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){
      setBox("#alert","Este formulário não está liberado para você.","err");
      return;
    }

    // Já respondeu?
    const already=await sheetSearch(SHEETS.SCORES,{cpf:CPF,code:CODE});
    const doneKeys=RELEASE_KEYS.map(k=>`${k}_FEITO`);
    const anyDoneFlag=doneKeys.some(k=>String(patient[k]||"").trim().toLowerCase()==="sim");
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200);
      return;
    }

    renderPatientInfo();
    renderQuestions();
    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    $("#progressWrap").style.display="block";
    hideBox("#alert");

    startAt = Date.now();
  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário.", "err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  const info=[
    ["Nome", patient.nome||"-"],
    ["Nascimento", fmtDateISO(patient.data_nascimento)]
  ];

  for(const [k,v] of info){
    const div=document.createElement("div");
    div.className="info";
    div.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ========= RASCUNHO ========= */
function saveDraft(){
  const data={};
  document.querySelectorAll('input[type="radio"][name^="q"]:checked').forEach(el=>{
    data[el.name]=Number(el.value);
  });
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(_){}
}
function restoreDraft(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return;
    const data=JSON.parse(raw||"{}");
    Object.entries(data).forEach(([k,v])=>{
      const el=document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el) el.checked=true;
    });
  }catch(_){}
}
function clearDraft(){
  try {
    localStorage.removeItem(STORAGE_KEY);
  } catch (_) {
    // ignore
  }
}
function countTotalItems(){
  return DOMAINS.reduce((a,d)=>a+d.items.length,0);
}
function countAnswered(){
  return document.querySelectorAll('input[type="radio"][name^="q"]:checked').length;
}
function updateProgress(){
  const ans=countAnswered(), tot=countTotalItems();
  $("#progressText").textContent=`Progresso: ${ans}/${tot}`;
  $("#bar").style.width=`${(ans/tot)*100}%`;
}

/* ========= EVENTOS ========= */
addEventListener('change', e=>{
  if(e.target && e.target.matches('input[type="radio"][name^="q"]')){
    saveDraft(); updateProgress();
  }
});
$("#btnSave").addEventListener('click', ()=>{
  saveDraft();
  setBox("#msg","Rascunho salvo neste dispositivo.","ok");
});
$("#clearDraft").addEventListener('click', ()=>{
  clearDraft();
  setBox("#msg","Rascunho apagado.","warn");
});

/* ========= CÁLCULOS ========= */
function domainSum(domainIndex){
  // soma dos valores marcados naquele domínio
  let base=0;
  for(let i=0;i<domainIndex;i++) base += DOMAINS[i].items.length;
  let sum=0;
  for(let j=1;j<=DOMAINS[domainIndex].items.length;j++){
    const qn=String(base+j).padStart(3,'0');
    const sel=document.querySelector(`input[name="q${qn}"]:checked`);
    sum += sel ? Number(sel.value) : 0;
  }
  return sum;
}
function totalSum(){
  let s=0;
  const n=countTotalItems();
  for(let i=1;i<=n;i++){
    const qn=String(i).padStart(3,'0');
    const sel=document.querySelector(`input[name="q${qn}"]:checked`);
    s += sel ? Number(sel.value) : 0;
  }
  return s;
}

/* ========= SUBMIT ========= */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending=true;
  hideBox("#msg");

  const btn=$("#btnSubmit");
  const t=btn.textContent;
  btn.disabled=true;
  btn.textContent="Enviando…";

  try{
    // validação: todos respondidos
    const tot=countTotalItems();
    for(let i=1;i<=tot;i++){
      const qn=String(i).padStart(3,'0');
      if(!document.querySelector(`input[name="q${qn}"]:checked`)){
        const row=document.querySelector(`.item[data-q="${i}"]`);
        if(row) row.scrollIntoView({behavior:'smooth',block:'center'});
        throw new Error(`Responda o item ${i}.`);
      }
    }

    // somatórios por domínio / total
    const somaCOM  = domainSum(0);
    const somaAVD  = domainSum(1);
    const somaSOC  = domainSum(2);
    const somaHMOT = domainSum(3);
    const total    = totalSum();

    const categoria_csv = [
      `Comunicacao=${somaCOM}`,
      `AVD=${somaAVD}`,
      `Socializacao=${somaSOC}`,
      `Atividades=${somaHMOT}`
    ].join(',');

    // montar perguntas/respostas para salvar em 'questions'
    // e também map de respostas numéricas pra metrics.answers
    const qaList = [];
    const answersMap = {};

    for(let i=1;i<=tot;i++){
      const qn = String(i).padStart(3,'0');
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      const rawVal = sel ? Number(sel.value) : null;

      // pega texto visível da opção (ex.: "Às vezes")
      let prettyVal = "";
      if(sel){
        const lbl = sel.closest('label.opt');
        if(lbl){
          const span = lbl.querySelector('span');
          if(span){ prettyVal = span.textContent.trim(); }
        }
      }

      // pega texto da pergunta (stem)
      const stemEl = document.getElementById(`s${qn}`);
      const qText = stemEl ? stemEl.textContent.replace(/^\s*\d+\.\s*/, "").trim() : `Item ${i}`;

      qaList.push({
        n: i,
        q: qText,
        raw: rawVal,
        pretty: prettyVal
      });

      answersMap[`q${qn}`] = rawVal;
    }

    // duração total da sessão
    const durationSec = Math.round((Date.now() - startAt)/1000);

    // escreve na planilha
    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: total,
      categoria: categoria_csv,
      questions: "",
      metrics: "",
    
    });

    // marca como feito
    const patch={};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      if(k in patient) patch[k]="sim";
    });
    if(Object.keys(patch).length===0){
      patch[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    }
    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,patch);

    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken,1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false;
    btn.disabled=false;
    btn.textContent=t;
  }
});
</script>
</body>
</html>
